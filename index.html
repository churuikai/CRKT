<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Markdown Preview</title>
    <link id="markdown-css" href="editormd/css/editormd.preview.css" rel="stylesheet"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        
        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.12);
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.12) transparent;
        }
        
        /* 单栏模式容器 */
        #single-mode-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 0px;
        }
        #single-mode-container.mode-hidden {
            display: none;
        }
        
        /* 原文输入框 */
        .source-textarea {
            width: 100%;
            min-height: 100%;
            padding: 0;
            font-size: 13px;
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            line-height: 1.6;
            overflow: hidden;
        }
        .source-textarea.state-locked {
            color: #999999;
        }
        
        /* 翻译视图 */
        #translation-view-single {
            width: 100%;
            height: auto;
        }
        
        /* 对照模式容器 */
        #dual-mode-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: none;
        }
        #dual-mode-container.mode-visible {
            display: flex;
        }
        #dual-mode-container.layout-horizontal {
            flex-direction: row;
        }
        #dual-mode-container.layout-horizontal .dual-pane {
            width: 50%;
            height: 100%;
        }
        #dual-mode-container.layout-horizontal .dual-divider {
            width: 2px;
            height: 100%;
            background: #e0e0e0;
            flex-shrink: 0;
            cursor: ew-resize;
            position: relative;
        }
        #dual-mode-container.layout-horizontal .dual-divider:hover {
            background: #c0c0c0;
        }
        #dual-mode-container.layout-vertical {
            flex-direction: column;
        }
        #dual-mode-container.layout-vertical .dual-pane {
            width: 100%;
            height: 50%;
        }
        #dual-mode-container.layout-vertical .dual-divider {
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            flex-shrink: 0;
            cursor: ns-resize;
            position: relative;
        }
        #dual-mode-container.layout-vertical .dual-divider:hover {
            background: #c0c0c0;
        }
        
        /* 对照模式面板 */
        .dual-pane {
            overflow-y: auto;
            position: relative;
            background: #ffffff;
            padding: 0px;
        }
        
        /* 对照模式原文区 */
        #source-pane-dual {
            position: relative;
        }
        #source-pane-dual .source-textarea {
            height: auto;
        }
        
        /* 对照模式翻译区 */
        #translation-view-dual {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- 单栏模式容器 -->
    <div id="single-mode-container">
        <div id="translation-view-single" style="display:none;"></div>
        <div style="padding: 10px;">
            <textarea id="source-textarea-single" class="source-textarea" placeholder="双击附加热键添加文本，双击翻译热键执行翻译。"></textarea>
        </div>
    </div>
    
    <!-- 对照模式容器 -->
    <div id="dual-mode-container">
        <div id="source-pane-dual" class="dual-pane dual-pane-source">
            <div style="padding: 10px;">
                <textarea id="source-textarea-dual" class="source-textarea" placeholder="原文区"></textarea>
            </div>
        </div>
        <div class="dual-divider"></div>
        <div id="translation-pane-dual" class="dual-pane dual-pane-translation">
            <div id="translation-view-dual"></div>
        </div>
    </div>
</body>
<script src="jquery.min.js"></script>
<script class="markdown" src="editormd/editormd.min.js"></script>
<script class="markdown" src="editormd/lib/marked.min.js"></script>
<script class="markdown" src="editormd/lib/prettify.min.js"></script>
<script>
    // ========== 数据层 ==========
    // 当前模式数据（前端维护）
    var sourceText = "";              // 当前原文内容
    var translationText = "";         // 当前翻译内容
    var isSourceLocked = false;       // 原文区是否锁定
    
    // 历史模式数据（后端注入）
    var historySourceText = "";       // 历史原文内容
    var historyTranslationText = "";  // 历史翻译内容
    var isHistoryMode = false;        // 是否处于历史模式
    
    // ========== DOM元素 ==========
    var sourceTextareaSingle = null;  // 单栏模式：原文输入框
    var sourceTextareaDual = null;    // 对照模式：原文输入框
    var sourcePane = null;            // 对照模式：原文面板
    var singleModeContainer = null;   // 单栏模式容器
    var dualModeContainer = null;     // 对照模式容器
    
    // ========== 状态变量 ==========
    var isDualMode = false;           // 是否为对照模式
    var isResizing = false;           // 是否正在拖动分隔线
    var sourcePaneSize = 40;          // 原文区大小百分比（默认40%）
    
    // ========== 初始化 ==========
    $(function () {
        editormd.katexURL = {
            js: 'katex/katex.min',
            css: 'katex/katex.min'
        };

        singleModeContainer = document.getElementById('single-mode-container');
        dualModeContainer = document.getElementById('dual-mode-container');
        sourcePane = document.getElementById('source-pane-dual');
        sourceTextareaSingle = document.getElementById('source-textarea-single');
        sourceTextareaDual = document.getElementById('source-textarea-dual');
        
        // 绑定输入事件
        if (sourceTextareaSingle) {
            sourceTextareaSingle.addEventListener('input', function() {
                // 历史模式下不允许编辑
                if (isHistoryMode) {
                    sourceTextareaSingle.value = historySourceText;
                    return;
                }
                sourceText = sourceTextareaSingle.value;
                autoResizeTextarea(sourceTextareaSingle);
                if (isSourceLocked) {
                    isSourceLocked = false;
                    if (sourceTextareaSingle) sourceTextareaSingle.classList.remove('state-locked');
                    if (sourceTextareaDual) sourceTextareaDual.classList.remove('state-locked');
                }
            });
        }
        
        if (sourceTextareaDual) {
            sourceTextareaDual.addEventListener('input', function() {
                // 历史模式下不允许编辑
                if (isHistoryMode) {
                    sourceTextareaDual.value = historySourceText;
                    return;
                }
                sourceText = sourceTextareaDual.value;
                autoResizeTextarea(sourceTextareaDual);
                if (isSourceLocked) {
                    isSourceLocked = false;
                    if (sourceTextareaSingle) sourceTextareaSingle.classList.remove('state-locked');
                    if (sourceTextareaDual) sourceTextareaDual.classList.remove('state-locked');
                }
            });
        }
        
        window.addEventListener('resize', updateLayoutDirection);
        initDividerDrag();
        initKeyboardNavigation();
    });
    
    // 初始化键盘导航（上下键历史翻阅）
    function initKeyboardNavigation() {
        document.addEventListener('keydown', function(e) {
            if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') {
                return;
            }
            
            // 历史模式下，上下键始终用于翻阅
            if (isHistoryMode) {
                console.log(e.key === 'ArrowUp' ? 'CRKT_ACTION:navigate-up' : 'CRKT_ACTION:navigate-down');
                e.preventDefault();
                return;
            }
            
            // 检查焦点是否在可编辑的 textarea 上
            var activeEl = document.activeElement;
            var isEditableTextarea = activeEl && 
                activeEl.tagName === 'TEXTAREA' && 
                !activeEl.readOnly && 
                activeEl.offsetParent !== null;  // offsetParent 为 null 表示元素隐藏
            
            if (isEditableTextarea) {
                return;  // 让光标正常移动
            }
            
            // 其他情况，上下键用于历史翻阅
            console.log(e.key === 'ArrowUp' ? 'CRKT_ACTION:navigate-up' : 'CRKT_ACTION:navigate-down');
            e.preventDefault();
        });
    }
    
    // 自动调整 textarea 高度
    function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
    

    // ========== 布局管理 ==========
    function updateLayoutDirection() {
        if (!isDualMode || !dualModeContainer) return;
        
        var width = window.innerWidth;
        var height = window.innerHeight;
        
        dualModeContainer.classList.remove('layout-horizontal', 'layout-vertical');
        if (width >= height) {
            dualModeContainer.classList.add('layout-horizontal');
            applyPaneSize(true);
        } else {
            dualModeContainer.classList.add('layout-vertical');
            applyPaneSize(false);
        }
    }
    
    function applyPaneSize(isHorizontal) {
        var sourcePane = document.getElementById('source-pane-dual');
        var translationPane = document.getElementById('translation-pane-dual');
        
        if (!sourcePane || !translationPane) return;
        
        if (isHorizontal) {
            sourcePane.style.width = sourcePaneSize + '%';
            sourcePane.style.height = '';
            translationPane.style.width = (100 - sourcePaneSize) + '%';
            translationPane.style.height = '';
        } else {
            sourcePane.style.width = '';
            sourcePane.style.height = sourcePaneSize + '%';
            translationPane.style.width = '';
            translationPane.style.height = (100 - sourcePaneSize) + '%';
        }
    }
    
    function initDividerDrag() {
        var divider = null;
        var startPos = 0;
        var startSize = 0;
        var isHorizontal = false;
        
        document.addEventListener('mousedown', function(e) {
            if (!isDualMode || !dualModeContainer) return;
            
            var target = e.target;
            if (target.classList.contains('dual-divider')) {
                isResizing = true;
                divider = target;
                
                isHorizontal = dualModeContainer.classList.contains('layout-horizontal');
                startPos = isHorizontal ? e.clientX : e.clientY;
                startSize = sourcePaneSize;
                
                e.preventDefault();
                document.body.style.cursor = isHorizontal ? 'ew-resize' : 'ns-resize';
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isResizing || !dualModeContainer) return;
            
            var containerSize = isHorizontal ? dualModeContainer.offsetWidth : dualModeContainer.offsetHeight;
            var currentPos = isHorizontal ? e.clientX : e.clientY;
            var delta = currentPos - startPos;
            var deltaPercent = (delta / containerSize) * 100;
            
            sourcePaneSize = Math.max(20, Math.min(80, startSize + deltaPercent));
            applyPaneSize(isHorizontal);
            
            e.preventDefault();
        });
        
        document.addEventListener('mouseup', function(e) {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
            }
        });
    }

    function setComparisonMode(enabled, retryCount) {
        retryCount = retryCount || 0;
        
        // 检查 DOM 是否已初始化
        if (!singleModeContainer || !dualModeContainer) {
            if (retryCount < 5) {
                console.warn('DOM 元素未初始化，100ms 后重试 (第 ' + (retryCount + 1) + ' 次)');
                setTimeout(function() {
                    setComparisonMode(enabled, retryCount + 1);
                }, 100);
            } else {
                console.error('DOM 元素初始化失败，已重试 5 次');
            }
            return;
        }
        
        if (enabled) {
            // 切换到对照模式
            singleModeContainer.classList.add('mode-hidden');
            dualModeContainer.classList.add('mode-visible');
            isDualMode = true;
            updateLayoutDirection();
            
            // 同步原文内容
            if (sourceTextareaDual) {
                sourceTextareaDual.value = sourceText;
                autoResizeTextarea(sourceTextareaDual);
            }
        } else {
            // 切换到单栏模式
            dualModeContainer.classList.remove('mode-visible');
            singleModeContainer.classList.remove('mode-hidden');
            isDualMode = false;
            
            // 同步原文内容
            if (sourceTextareaSingle) {
                sourceTextareaSingle.value = sourceText;
                autoResizeTextarea(sourceTextareaSingle);
            }
        }
    }

    // ========== 原文区锁定 ==========
    function lockSourcePane() {
        isSourceLocked = true;
        if (sourceTextareaSingle) sourceTextareaSingle.classList.add('state-locked');
        if (sourceTextareaDual) sourceTextareaDual.classList.add('state-locked');
    }
    
    function unlockSourcePane() {
        isSourceLocked = false;
        if (sourceTextareaSingle) sourceTextareaSingle.classList.remove('state-locked');
        if (sourceTextareaDual) sourceTextareaDual.classList.remove('state-locked');
    }
    
    function isSourcePaneLocked() {
        return isSourceLocked;
    }

    // ========== 数据更新接口（当前模式） ==========
    function updateSource(text) {
        sourceText = text || "";
        
        // 如果在历史模式，不更新当前数据
        if (isHistoryMode) return;
        
        // 切换单栏模式显示为原文输入框
        var translationView = document.getElementById('translation-view-single');
        if (translationView) translationView.style.display = "none";
        if (sourceTextareaSingle) {
            sourceTextareaSingle.style.display = "block";
            sourceTextareaSingle.value = sourceText;
            autoResizeTextarea(sourceTextareaSingle);
        }
        
        // 更新对照模式输入框内容
        if (sourceTextareaDual) {
            sourceTextareaDual.value = sourceText;
            autoResizeTextarea(sourceTextareaDual);
        }
    }
    
    function appendSource(text) {
        if (!text) return;
        
        // 如果在历史模式，不允许追加
        if (isHistoryMode) return;
        
        // 单栏模式：确保原文输入框可见
        if (!isDualMode) {
            var translationView = document.getElementById('translation-view-single');
            if (translationView) translationView.style.display = "none";
            if (sourceTextareaSingle) sourceTextareaSingle.style.display = "block";
        }
        
        // 获取当前激活的 textarea
        var activeTextarea = isDualMode ? sourceTextareaDual : sourceTextareaSingle;
        if (!activeTextarea) return;
        
        // 保存外部容器的滚动位置
        var scrollContainer = activeTextarea.parentElement.parentElement;
        var scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
        
        // 获取光标位置
        var start = activeTextarea.selectionStart;
        var end = activeTextarea.selectionEnd;
        var currentValue = activeTextarea.value;
        
        // 在光标位置直接插入文本
        var prefix = currentValue.substring(0, start);
        var suffix = currentValue.substring(end);
        var newValue = prefix + text + suffix;
        
        // 更新内容
        sourceText = newValue;
        activeTextarea.value = newValue;
        
        // 设置光标位置到插入文本之后
        var newCursorPos = start + text.length;
        activeTextarea.selectionStart = newCursorPos;
        activeTextarea.selectionEnd = newCursorPos;
        
        // 同步另一个 textarea
        var otherTextarea = isDualMode ? sourceTextareaSingle : sourceTextareaDual;
        if (otherTextarea) {
            otherTextarea.value = newValue;
        }
        
        // 自动调整高度
        autoResizeTextarea(activeTextarea);
        if (otherTextarea) autoResizeTextarea(otherTextarea);
        
        // 恢复滚动位置（必须在 autoResize 之后）
        if (scrollContainer) {
            scrollContainer.scrollTop = scrollTop;
        }
        
        // 聚焦（不使用 focus，避免滚动）
        activeTextarea.setSelectionRange(newCursorPos, newCursorPos);
        
        // 解锁原文区
        unlockSourcePane();
    }
    
    function updateTranslation(markdown) {
        translationText = markdown || "";
        
        // 如果在历史模式，不更新当前数据
        if (isHistoryMode) return;
        
        var markdownConfig = {
            markdown: translationText,
            htmlDecode: true,
            htmlDecode: "style,script,iframe",
            fontSize: "13px",
            tex: true,
            autoFocus: false,
        };
        
        // 切换单栏模式显示为翻译视图
        var translationView = document.getElementById('translation-view-single');
        if (sourceTextareaSingle) sourceTextareaSingle.style.display = "none";
        if (translationView) translationView.style.display = "block";
        
        $('#translation-view-single').html("");
        editormd.markdownToHTML("translation-view-single", markdownConfig);
        
        // 更新对照模式翻译显示
        $('#translation-view-dual').html("");
        editormd.markdownToHTML("translation-view-dual", markdownConfig);
    }
    
    function getSource() {
        return isHistoryMode ? historySourceText : sourceText;
    }

    // ========== 查询接口 ==========
    function isLocked() {
        return isSourceLocked;
    }
    
    // ========== 历史模式接口 ==========
    function enterHistoryMode(source, translation) {
        isHistoryMode = true;
        historySourceText = source || "";
        historyTranslationText = translation || "";
        
        var markdownConfig = {
            markdown: historyTranslationText,
            htmlDecode: true,
            htmlDecode: "style,script,iframe",
            fontSize: "13px",
            tex: true,
            autoFocus: false,
        };
        
        if (isDualMode) {
            // 对照模式：显示原文和翻译
            if (sourceTextareaDual) {
                sourceTextareaDual.value = historySourceText;
                sourceTextareaDual.readOnly = true;
                sourceTextareaDual.style.backgroundColor = "#f9f9f9";
                autoResizeTextarea(sourceTextareaDual);
            }
            
            $('#translation-view-dual').html("");
            editormd.markdownToHTML("translation-view-dual", markdownConfig);
        } else {
            // 单栏模式：只显示翻译结果
            var translationView = document.getElementById('translation-view-single');
            if (sourceTextareaSingle) sourceTextareaSingle.style.display = "none";
            if (translationView) translationView.style.display = "block";
            
            $('#translation-view-single').html("");
            editormd.markdownToHTML("translation-view-single", markdownConfig);
        }
    }
    
    function exitHistoryMode() {
        isHistoryMode = false;
        historySourceText = "";
        historyTranslationText = "";
        
        // 恢复当前模式数据
        if (isDualMode) {
            if (sourceTextareaDual) {
                sourceTextareaDual.value = sourceText;
                sourceTextareaDual.readOnly = false;
                sourceTextareaDual.style.backgroundColor = "";
                autoResizeTextarea(sourceTextareaDual);
            }
            
            var markdownConfig = {
                markdown: translationText,
                htmlDecode: true,
                htmlDecode: "style,script,iframe",
                fontSize: "13px",
                tex: true,
                autoFocus: false,
            };
            $('#translation-view-dual').html("");
            editormd.markdownToHTML("translation-view-dual", markdownConfig);
        } else {
            // 单栏模式：恢复原文输入框或翻译结果
            var translationView = document.getElementById('translation-view-single');
            if (translationText) {
                // 有翻译结果，显示翻译
                if (sourceTextareaSingle) sourceTextareaSingle.style.display = "none";
                if (translationView) translationView.style.display = "block";
                
                var markdownConfig = {
                    markdown: translationText,
                    htmlDecode: true,
                    htmlDecode: "style,script,iframe",
                    fontSize: "13px",
                    tex: true,
                    autoFocus: false,
                };
                $('#translation-view-single').html("");
                editormd.markdownToHTML("translation-view-single", markdownConfig);
            } else {
                // 没有翻译结果，显示原文输入框
                if (translationView) translationView.style.display = "none";
                if (sourceTextareaSingle) {
                    sourceTextareaSingle.style.display = "block";
                    sourceTextareaSingle.value = sourceText;
                    autoResizeTextarea(sourceTextareaSingle);
                }
            }
        }
    }
</script>
</html>
